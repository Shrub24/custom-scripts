#!/bin/bash
set -euo pipefail

# --- 1. Load Configuration ---
# Find the config file
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/custom-scripts"
CONFIG_FILE="$CONFIG_DIR/config.sh"

# Check if config exists and load it
if [ -f "$CONFIG_FILE" ]; then
    # Source the shell config file
    source "$CONFIG_FILE"
else
    echo "Error: Config file not found at $CONFIG_FILE" >&2
    echo "Please run the install.sh script from your 'custom-scripts' repo." >&2
    exit 1
fi

# Check that the variable was loaded
if [ -z "$PKG_BASE_DIR" ]; then
    echo "Error: PKG_BASE_DIR not set in $CONFIG_FILE." >&2
    exit 1
fi
# --- (End of new logic) ---


# --- 2. Execute Package ---
# (This logic is now the same as before, but $PKG_BASE_DIR is dynamic)
PACKAGE_NAME=$1
shift # Get the package name

PKG_DIR="$PKG_BASE_DIR/modules/$PACKAGE_NAME"

if [ ! -d "$PKG_DIR" ]; then
    echo "Error: Package '$PACKAGE_NAME' not found under modules/." >&2
    echo "Expected directory: $PKG_DIR" >&2
    exit 1
fi
VENV_DIR="$PKG_DIR/.venv"
VENV_PYTHON="$VENV_DIR/bin/python"
PKG_MAIN_PY="$PKG_DIR/main.py"

# Determine module type and execute accordingly
if [ -f "$PKG_MAIN_PY" ]; then
    # Python module - check if it's a package (has __init__.py)
    if [ -f "$PKG_DIR/__init__.py" ]; then
        # Run as module to enable relative imports
        if [ -f "$VENV_PYTHON" ]; then
            cd "$PKG_DIR/.." && exec "$VENV_PYTHON" -m "$PACKAGE_NAME.main" "$@"
        else
            echo "Warning: No venv found for module '$PACKAGE_NAME', using system python" >&2
            cd "$PKG_DIR/.." && exec python3 -m "$PACKAGE_NAME.main" "$@"
        fi
    else
        # Run as script
        if [ -f "$VENV_PYTHON" ]; then
            exec "$VENV_PYTHON" "$PKG_MAIN_PY" "$@"
        else
            echo "Warning: No venv found for module '$PACKAGE_NAME', using system python" >&2
            exec python3 "$PKG_MAIN_PY" "$@"
        fi
    fi
elif [ -f "$PKG_DIR/main.sh" ]; then
    # Shell script module
    exec "$PKG_DIR/main.sh" "$@"
else
    echo "Error: No main.py or main.sh found in package '$PACKAGE_NAME'." >&2
    exit 1
fi