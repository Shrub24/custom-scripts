#!/usr/bin/env bash
#
# chezmoi-sym: Manage symlinked files in chezmoi
# Usage: chezmoi-sym [add|remove] [-v|--verbose] [path]
# Examples: 
#   chezmoi-sym add ~/.config/myapp/settings.json
#   chezmoi-sym add -v ~/.config/myapp/settings.json
#   chezmoi-sym add ~/.config/myapp/
#   chezmoi-sym remove ~/.config/myapp/settings.json
#   chezmoi-sym remove -v ~/.config/myapp/settings.json
#   chezmoi-sym remove ~/.config/myapp/
#

set -e

# Show usage
show_usage() {
    echo "Usage: chezmoi-sym [add|remove] [-v|--verbose] [path]"
    echo ""
    echo "Commands:"
    echo "  add     Add a file or directory to chezmoi as symlinks"
    echo "  remove  Remove symlinked files or directories from chezmoi"
    echo ""
    echo "Options:"
    echo "  -v, --verbose  Show detailed operation logs"
    echo ""
    echo "Examples:"
    echo "  chezmoi-sym add ~/.config/myapp/settings.json"
    echo "  chezmoi-sym add -v ~/.config/myapp/settings.json"
    echo "  chezmoi-sym add ~/.config/myapp/"
    echo "  chezmoi-sym remove ~/.config/myapp/settings.json"
    echo "  chezmoi-sym remove -v ~/.config/myapp/settings.json"
    echo "  chezmoi-sym remove ~/.config/myapp/"
}

# Helper function for verbose output
log_verbose() {
    if [[ $VERBOSE -eq 1 ]]; then
        echo "[VERBOSE] $*"
    fi
}

# Parse command
if [[ $# -eq 0 ]]; then
    show_usage
    exit 1
fi

COMMAND="$1"
shift

if [[ "$COMMAND" != "add" && "$COMMAND" != "remove" ]]; then
    echo "Error: Invalid command '$COMMAND'. Must be 'add' or 'remove'."
    echo ""
    show_usage
    exit 1
fi

# Parse arguments
VERBOSE=0
file_path=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -v|--verbose)
            VERBOSE=1
            shift
            ;;
        *)
            file_path="$1"
            shift
            ;;
    esac
done

if [[ -z "$file_path" ]]; then
    echo "Error: No file path provided"
    echo ""
    show_usage
    exit 1
fi

# Resolve to absolute path
if [[ "$file_path" != /* ]]; then
    log_verbose "Resolving relative path to absolute path"
    file_path="$(realpath "$file_path")"
fi
log_verbose "Target file: $file_path"

# Get chezmoi source directory
chezmoi_source_dir="$(chezmoi source-path)"
log_verbose "Chezmoi source directory: $chezmoi_source_dir"

# Helper function to add a single file
add_single_file() {
    local file_path="$1"
    
    log_verbose "Processing file: $file_path"
    
    # Check if file exists
    if [[ ! -e "$file_path" ]]; then
        echo "Error: File '$file_path' does not exist"
        return 1
    fi

    # Add the file to chezmoi with --template flag
    log_verbose "Running: chezmoi add --template \"$file_path\""
    chezmoi add --template "$file_path"

    # Get the source path for the added file
    local chezmoi_file
    chezmoi_file="$(chezmoi source-path "$file_path")"
    log_verbose "Chezmoi file path: $chezmoi_file"

    # The file should have .tmpl extension from chezmoi add --template
    local chezmoi_base="${chezmoi_file%.tmpl}"
    local chezmoi_dir="$(dirname "$chezmoi_base")"
    local chezmoi_filename="$(basename "$chezmoi_base")"
    log_verbose "Base path: $chezmoi_base"
    log_verbose "Directory: $chezmoi_dir"
    log_verbose "Filename: $chezmoi_filename"

    # Add symlink_ prefix to the filename
    local new_chezmoi_file="$chezmoi_dir/symlink_$chezmoi_filename.tmpl"

    # Rename the template file to add symlink_ prefix
    log_verbose "Moving: $chezmoi_file -> $new_chezmoi_file"
    mv "$chezmoi_file" "$new_chezmoi_file"

    # Determine relative path from chezmoi source dir for the symlink destination
    local rel_path="${chezmoi_base#$chezmoi_source_dir/}"
    log_verbose "Relative path: $rel_path"

    # Determine the symlink destination path
    local symlink_dest="$chezmoi_source_dir/symlinks/$rel_path"
    log_verbose "Symlink destination: $symlink_dest"

    # Create directory structure for symlink if needed
    local symlink_dir="$(dirname "$symlink_dest")"
    if [[ ! -d "$symlink_dir" ]]; then
        log_verbose "Creating directory structure for symlink: $symlink_dir"
        mkdir -p "$symlink_dir"
    fi

    # Copy the actual file content to symlinks directory
    log_verbose "Copying: $file_path -> $symlink_dest"
    cp "$file_path" "$symlink_dest"

    # Replace template file contents with symlink reference
    log_verbose "Writing symlink template reference to: $new_chezmoi_file"
    echo '{{- template "symlink" .}}' > "$new_chezmoi_file"

    log_verbose "✓ Successfully added symlinked file to chezmoi"
    log_verbose "  Original file: $file_path"
    log_verbose "  Symlink target: $symlink_dest"
    log_verbose "  Template file: $new_chezmoi_file"
    log_verbose ""
}

# Helper function to remove a single file
remove_single_file() {
    local file_path="$1"
    
    log_verbose "Processing file: $file_path"
    
    # Get the chezmoi source path for the file
    local chezmoi_file
    chezmoi_file="$(chezmoi source-path "$file_path" 2>/dev/null || echo "")"

    if [[ -z "$chezmoi_file" ]]; then
        echo "Warning: File '$file_path' is not managed by chezmoi, skipping"
        return 0
    fi
    log_verbose "Chezmoi source file: $chezmoi_file"

    # Check if it's a symlinked file (has symlink_ prefix)
    local chezmoi_filename="$(basename "$chezmoi_file")"
    if [[ ! "$chezmoi_filename" =~ ^symlink_ ]]; then
        echo "Warning: File '$file_path' doesn't appear to be a symlinked file (no 'symlink_' prefix), skipping"
        return 0
    fi

    # Determine the symlink target path in the symlinks directory
    local chezmoi_base="${chezmoi_file%.tmpl}"
    local chezmoi_dir="$(dirname "$chezmoi_base")"
    local chezmoi_base_filename="$(basename "$chezmoi_base")"
    # Remove symlink_ prefix
    local chezmoi_base_no_prefix="$chezmoi_dir/${chezmoi_base_filename#symlink_}"
    local rel_path="${chezmoi_base_no_prefix#$chezmoi_source_dir/}"
    local symlink_target="$chezmoi_source_dir/symlinks/$rel_path"
    log_verbose "Symlink target: $symlink_target"

    # Copy the symlink target back to the original location if it exists
    if [[ -f "$symlink_target" ]]; then
        # Check if the current file is a symlink
        if [[ -L "$file_path" ]]; then
            log_verbose "Removing existing symlink at: $file_path"
            rm "$file_path"
        fi
        
        # Create directory structure if needed
        local file_dir="$(dirname "$file_path")"
        if [[ ! -d "$file_dir" ]]; then
            log_verbose "Creating directory structure: $file_dir"
            mkdir -p "$file_dir"
        fi
        
        log_verbose "Copying: $symlink_target -> $file_path"
        cp "$symlink_target" "$file_path"
    else
        log_verbose "Symlink target not found: $symlink_target (cannot restore file)"
    fi

    # Use chezmoi forget to remove the template file
    log_verbose "Running: chezmoi forget \"$file_path\""
    chezmoi forget "$file_path"

    # Remove the symlink target file
    if [[ -f "$symlink_target" ]]; then
        log_verbose "Deleting: $symlink_target"
        rm "$symlink_target"
        
        # Clean up empty parent directories
        local symlink_dir="$(dirname "$symlink_target")"
        log_verbose "Checking for empty directories to clean up"
        while [[ "$symlink_dir" != "$chezmoi_source_dir/symlinks" ]] && [[ -d "$symlink_dir" ]] && [[ -z "$(ls -A "$symlink_dir")" ]]; do
            log_verbose "Removing empty directory: $symlink_dir"
            rmdir "$symlink_dir"
            symlink_dir="$(dirname "$symlink_dir")"
        done
    fi

    log_verbose "✓ Successfully removed symlinked file from chezmoi"
    log_verbose "  Original file: $file_path (restored from symlink target)"
    log_verbose "  Template removed: $chezmoi_file"
    log_verbose "  Target removed: $symlink_target"
    log_verbose ""
}

#######################################
# ADD COMMAND
#######################################
if [[ "$COMMAND" == "add" ]]; then
    # Check if path exists
    if [[ ! -e "$file_path" ]]; then
        echo "Error: Path '$file_path' does not exist"
        exit 1
    fi
    
    # Handle directory recursively
    if [[ -d "$file_path" ]]; then
        log_verbose "Directory detected, processing recursively..."
        
        # Find all files in directory (not directories themselves)
        while IFS= read -r -d '' file; do
            add_single_file "$file"
        done < <(find "$file_path" -type f -print0)
        
        log_verbose ""
        log_verbose "Next steps:"
        log_verbose "  1. Run 'chezmoi apply' to create the symlinks"
        log_verbose "  2. Consider running 'git add' in the chezmoi source directory"
    else
        # Single file
        add_single_file "$file_path"
        
        log_verbose ""
        log_verbose "Next steps:"
        log_verbose "  1. Run 'chezmoi apply' to create the symlink"
        log_verbose "  2. Consider running 'git add' in the chezmoi source directory"
    fi

#######################################
# REMOVE COMMAND
#######################################
elif [[ "$COMMAND" == "remove" ]]; then
    # Check if path exists in chezmoi
    if [[ -d "$file_path" ]]; then
        log_verbose "Directory detected, processing recursively..."
        
        # Find all files in directory (not directories themselves)
        while IFS= read -r -d '' file; do
            remove_single_file "$file"
        done < <(find "$file_path" -type f -print0)
        
        log_verbose "Files have been restored from their symlink targets to their original locations."
    else
        # Single file
        remove_single_file "$file_path"
        
        log_verbose "File has been restored from symlink target to its original location."
    fi
fi
